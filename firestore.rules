
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    function isGuru() {
      return request.auth.token.role == 'guru';
    }

    function isAdmin() {
      return request.auth.token.role == 'admin';
    }

    function isSignedIn() {
      return request.auth != null;
    }
    
    // User Profiles
    match /users/{userId} {
      allow read: if isSignedIn(); // Allow any signed-in user to read any profile (for display names, etc.)
      allow write: if isAdmin() || request.auth.uid == userId; // Allow admin or the user themselves to update their profile
    }

    // Student Data
    match /siswa/{studentId} {
      allow read: if isSignedIn(); // Any signed-in user can see student lists
      allow write: if isAdmin(); // Only admins can create, update, delete students
    }

    // Grades
    match /nilai/{gradeId} {
        // Teachers can create/update their own grade entries. Admins can do anything.
        allow read: if isSignedIn();
        allow create: if (isGuru() && request.resource.data.teacherUid == request.auth.uid) || isAdmin();
        allow update: if (isGuru() && resource.data.teacherUid == request.auth.uid) || isAdmin();
        allow delete: if isAdmin(); // Only admins can delete grade records
    }
    
    // Grade Weights
    match /bobot/{weightId} {
      allow read: if isSignedIn(); // All users can read the weight settings
      allow write: if isAdmin(); // Only admins can change weights
    }
    
    // Academic Year Settings
    match /academicYearConfigs/{yearId} {
        allow read: if isSignedIn();
        allow write: if isAdmin();
    }
    
    // KKM Settings
    match /kkm_settings/{kkmId} {
        allow read: if isSignedIn();
        allow write: if isAdmin();
    }

    // Mata Pelajaran Master
    match /mataPelajaranMaster/{mapelId} {
        allow read: if isSignedIn();
        allow write: if isAdmin();
    }
    
    // Announcements
    match /pengumuman/{pengumumanId} {
        allow read: if isSignedIn();
        allow write: if isAdmin();
    }

    // Daily Teacher Attendance
    match /teacherDailyAttendance/{attendanceId} {
        // A teacher can create/update their own daily attendance. An admin can do anything.
        allow read: if isSignedIn();
        allow create, update: if (isGuru() && request.resource.data.teacherUid == request.auth.uid) || isAdmin();
        allow delete: if isAdmin();
    }
    
    // School Profile Config
    match /schoolConfig/{configId} {
        allow read: if isSignedIn();
        allow write: if isAdmin();
    }
    
    // Student Violations
    match /pelanggaran_siswa/{pelanggaranId} {
        // Any teacher/admin can read. Only specific roles can write. Admin can delete.
        allow read: if isSignedIn();
        allow create, update: if isGuru() || isAdmin();
        allow delete: if isAdmin();
    }

    // Activity Reports
    match /laporan_kegiatan/{reportId} {
      // Any teacher/admin can read all reports for the admin view.
      allow read: if isSignedIn();
      
      // A teacher can only create a report for themselves. Admin can create any.
      allow create: if (isGuru() && request.resource.data.createdByUid == request.auth.uid) || isAdmin();
      
      // A teacher can only update/delete their OWN report. Admin can update/delete any.
      allow update, delete: if (isGuru() && resource.data.createdByUid == request.auth.uid) || isAdmin();
    }

    // Agenda Kelas
    match /agenda_kelas/{agendaId} {
        allow read: if isSignedIn();
        allow create: if (isGuru() && request.resource.data.teacherUid == request.auth.uid) || isAdmin();
        allow update, delete: if (isGuru() && resource.data.teacherUid == request.auth.uid) || isAdmin();
    }

    // Generic Activity Log (Admin only write)
    match /activity_logs/{logId} {
        allow read: if isAdmin();
        allow write: if isAdmin();
    }
  }
}
