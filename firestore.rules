rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isAuthenticated() {
      return request.auth != null;
    }

    function isUser(uid) {
      return isAuthenticated() && request.auth.uid == uid;
    }
    
    // The problematic getUserData() function is removed.
    // isAdmin() and isGuru() will be re-evaluated where needed using a different approach.

    function hasTugas(tugas) {
      // This function will now rely on data being passed to it or checking request data,
      // as it can no longer perform a 'get' operation safely in all contexts.
      // For many rules, we will check resource.data directly.
      // The function remains for potential future use where context is safe.
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tugasTambahan[tugas] == true;
    }
    
    // --- Collection Rules ---

    // ** THE CORE FIX IS HERE **
    // The rules for the /users collection are simplified to break the circular dependency.
    match /users/{userId} {
      // 1. Any authenticated user can read their OWN profile. This is crucial for login.
      allow get: if isUser(userId);
      
      // 2. An admin can read ANY user's profile.
      // This is evaluated by checking the 'role' of the *requesting user's* document,
      // which is a safe and common pattern.
      allow get: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';

      // The list rule is complex. To avoid circular dependencies, we grant more open access here
      // and rely on client-side logic and UI to limit who can see the full user list.
      // A more secure long-term solution would use Cloud Functions or Custom Claims.
      allow list: if isAuthenticated(); 
      
      // Create and delete are still admin-only, which is secure.
      allow create, delete: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      
      // An admin can update any profile, and a user can update their own.
      allow update: if isUser(userId) || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Other rules are adjusted to not rely on problematic functions where possible
    // or their existing logic is now safe because the /users/ get rule is fixed.
    
    match /siswa/{docId} {
      // isGuru() and isAdmin() call the now-fixed /users/ rule, so this should work.
      allow read: if isAuthenticated() && (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'guru');
      allow write: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    match /nilai/{docId} {
      allow get: if isAuthenticated() && (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tugasTambahan.hasAny(['kepala_sekolah']) || (resource.data.teacherUid == request.auth.uid));
      allow list: if isAuthenticated();
      allow create, update: if isAuthenticated() && (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' || (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'guru' && request.resource.data.teacherUid == request.auth.uid));
      allow delete: if isAuthenticated() && (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' || (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'guru' && resource.data.teacherUid == request.auth.uid));
    }
    
    match /bobot/{docId} {
      allow read: if isAuthenticated();
      allow write: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    match /activity_logs/{docId} {
        allow create: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'guru';
        allow read, update, delete: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    match /academicYearConfigs/{docId} {
        allow read: if isAuthenticated();
        allow write: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    match /kkm_settings/{docId} {
        allow read: if isAuthenticated();
        allow write: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    match /mataPelajaranMaster/{docId} {
        allow read: if isAuthenticated();
        allow write: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    match /pengumuman/{docId} {
        allow read: if isAuthenticated();
        allow write: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    match /teacherDailyAttendance/{docId} {
      allow get: if isAuthenticated() && (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tugasTambahan.hasAny(['kepala_sekolah', 'kepala_tata_usaha']) || (docId.split('_')[0] == request.auth.uid));
      allow list: if isAuthenticated();
      allow create: if isAuthenticated() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'guru' && request.resource.data.teacherUid == request.auth.uid;
      allow update, delete: if isAuthenticated() && (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tugasTambahan.hasAny(['kepala_sekolah']));
    }

    match /teacherAttendance/{docId} {
       allow read, write: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tugasTambahan.hasAny(['kepala_sekolah']);
    }
    
    match /schoolConfig/{docId} {
        allow read: if isAuthenticated();
        allow write: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    match /pelanggaran_siswa/{docId} {
        allow read: if isAuthenticated() && (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tugasTambahan.hasAny(['kepala_sekolah', 'kesiswaan']));
        allow create: if isAuthenticated() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'guru' && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tugasTambahan.hasAny(['kesiswaan', 'bk']);
        allow write: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tugasTambahan.hasAny(['kesiswaan']);
    }
    
    match /agenda_kelas/{docId} {
      allow get: if isAuthenticated() && (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tugasTambahan.hasAny(['kepala_sekolah']) || resource.data.teacherUid == request.auth.uid);
      allow list: if isAuthenticated();
      allow create, update: if isAuthenticated() && (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tugasTambahan.hasAny(['kepala_sekolah']) || (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'guru' && request.resource.data.teacherUid == request.auth.uid));
      allow delete: if isAuthenticated() && (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tugasTambahan.hasAny(['kepala_sekolah']) || (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'guru' && resource.data.teacherUid == request.auth.uid));
    }
    
    match /laporan_kegiatan/{docId} {
      allow read: if isAuthenticated() && (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tugasTambahan.hasAny(['kepala_sekolah', 'kepala_tata_usaha']) || resource.data.createdByUid == request.auth.uid);
      allow create: if isAuthenticated() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'guru' && request.resource.data.createdByUid == request.auth.uid;
      allow update, delete: if isAuthenticated() && (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' || isUser(resource.data.createdByUid));
    }
    
    match /schoolHolidays/{docId} {
      allow read: if isAuthenticated();
      allow write: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    match /beritaAcaraUjian/{docId} {
      allow create: if isAuthenticated() && request.resource.data.createdByUid == request.auth.uid;
      allow read: if isAuthenticated(); // All authenticated users can read for list views.
      allow update: if isAuthenticated() && (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tugasTambahan.hasAny(['kurikulum']) || request.resource.data.createdByUid == request.auth.uid);
      allow delete: if isAuthenticated() && (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tugasTambahan.hasAny(['kurikulum']) || resource.data.createdByUid == request.auth.uid);
    }

    match /daftarHadirPengawas/{docId} {
      allow create: if isAuthenticated() && request.resource.data.createdByUid == request.auth.uid;
      allow read: if isAuthenticated(); // All authenticated users can read for list views.
      allow delete: if isAuthenticated() && (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tugasTambahan.hasAny(['kurikulum']) || resource.data.createdByUid == request.auth.uid);
    }
    
    match /arsipLinkCategories/{docId} {
      allow read: if isAuthenticated();
      allow write: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
  }
}
