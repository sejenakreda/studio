
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ===== Helper Functions =====
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    function getRole() {
      return 'role' in getUserData() ? getUserData().role : '';
    }
    
    function hasTugas(tugas) {
      let data = getUserData();
      return 'tugasTambahan' in data && data.tugasTambahan is list && tugas in data.tugasTambahan;
    }

    function isAdmin() {
      return isSignedIn() && getRole() == 'admin';
    }

    function isGuru() {
      return isSignedIn() && getRole() == 'guru';
    }
    
    function isKepalaSekolah() {
      return isSignedIn() && hasTugas('kepala_sekolah');
    }
    
    function isKesiswaan() {
      return isSignedIn() && hasTugas('kesiswaan');
    }
    
    function isKepalaTataUsaha() {
      return isSignedIn() && hasTugas('kepala_tata_usaha');
    }

    // ===== Default Rule: Deny All =====
    match /{document=**} {
      allow read, write: if false;
    }

    // ===== Collection Rules =====

    // --- User Profiles ---
    match /users/{userId} {
      allow read: if isAdmin() || isKepalaSekolah() || isOwner(userId);
      allow update: if isAdmin() || isOwner(userId);
      allow create, delete: if isAdmin();
    }
    
    // --- Students ---
    match /siswa/{studentId} {
      allow read: if isSignedIn();
      allow create, update, delete: if isAdmin();
    }
    
    // --- Grades ---
    match /nilai/{gradeId} {
      allow read: if isAdmin() || isKepalaSekolah() || isOwner(resource.data.teacherUid);
      allow create, update: if isGuru();
      allow delete: if isAdmin();
    }
    
    // --- Academic Settings ---
    match /bobot/global_weights { allow read: if isSignedIn(); allow write: if isAdmin(); }
    match /mataPelajaranMaster/{mapelId} { allow read: if isSignedIn(); allow create, update, delete: if isAdmin(); }
    match /academicYearConfigs/{yearId} { allow read: if isSignedIn(); allow create, update, delete: if isAdmin(); }
    match /kkm_settings/{kkmId} { allow read: if isSignedIn(); allow create, update, delete: if isAdmin(); }

    // --- Communication & Reports ---
    match /pengumuman/{announcementId} {
      allow read: if isSignedIn();
      allow create, delete: if isAdmin();
    }

    match /teacherDailyAttendance/{dailyId} {
       // A user can read their own attendance (single doc or list). Admin/Kepsek can read any.
       // This rule handles both `get` (by doc ID) and `list` (by resource data) requests correctly.
       allow read: if isAdmin() || isKepalaSekolah() || isOwner(dailyId.split('_')[0]) || isOwner(resource.data.teacherUid);
       allow create: if isOwner(resource.data.teacherUid);
       allow update: if isOwner(resource.data.teacherUid) || isAdmin();
       allow delete: if isAdmin();
    }
    
    match /pelanggaran_siswa/{violationId} {
        // Admins, Kepsek, Kesiswaan, and BK can read all. Any guru can create.
        allow read: if isAdmin() || isKepalaSekolah() || isKesiswaan() || hasTugas('bk');
        allow create: if isGuru();
        allow update, delete: if isAdmin();
    }

    match /laporan_kegiatan/{reportId} {
        // Admins, Kepsek, and Kepala TU can read all reports. A guru can read their own.
        allow read: if isAdmin() || isKepalaSekolah() || isKepalaTataUsaha() || isOwner(resource.data.createdByUid);
        allow create: if isGuru();
        allow update, delete: if isAdmin() || isOwner(resource.data.createdByUid);
    }
    
    match /agenda_kelas/{agendaId} {
        // Admins and Kepsek can read all agendas. A guru can read their own.
        allow read: if isAdmin() || isKepalaSekolah() || isOwner(resource.data.teacherUid);
        allow create: if isGuru();
        allow update, delete: if isAdmin() || isOwner(resource.data.teacherUid);
    }

    // --- System & Config ---
    match /schoolConfig/main_profile {
        allow read: if isSignedIn();
        allow write: if isAdmin();
    }

    match /activity_logs/{logId} {
      allow read, write: if isAdmin();
    }
  }
}
