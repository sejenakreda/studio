rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ===== Helper Functions =====
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function getRole() {
      return getUserData().role;
    }

    function isAdmin() {
      return isSignedIn() && getRole() == 'admin';
    }

    function isGuru() {
        return isSignedIn() && getRole() == 'guru';
    }

    function isReportViewer() {
        let userTugas = getUserData().tugasTambahan;
        if (userTugas == null) {
            return false;
        }
        // These roles can view all reports, not just their own.
        return userTugas.hasAny(['kepala_sekolah', 'kepala_tata_usaha', 'kesiswaan', 'kurikulum']);
    }

    // ===== Default Rule: Deny All =====
    match /{document=**} {
      allow read, write: if false;
    }

    // ===== Collection Rules =====

    // --- User Profiles ---
    match /users/{userId} {
      allow read: if isAdmin() || isOwner(userId);
      allow update: if isAdmin() || isOwner(userId);
      allow create, delete: if isAdmin();
    }
    
    // --- Students ---
    match /siswa/{studentId} {
      allow read: if isSignedIn();
      allow create, update, delete: if isAdmin();
    }
    
    // --- Grades ---
    match /nilai/{gradeId} {
      allow read: if isSignedIn();
      allow create, update: if isGuru();
      allow delete: if isAdmin();
    }
    
    // --- Academic Settings ---
    match /bobot/global_weights {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }
    
    match /mataPelajaranMaster/{mapelId} {
      allow read: if isSignedIn();
      allow create, update, delete: if isAdmin();
    }
    
    match /academicYearConfigs/{yearId} {
        allow read: if isSignedIn();
        allow create, update, delete: if isAdmin();
    }
    
    match /kkm_settings/{kkmId} {
        allow read: if isSignedIn();
        allow create, update, delete: if isAdmin();
    }

    // --- Communication & Reports ---
    
    match /pengumuman/{announcementId} {
        allow read: if isSignedIn();
        allow create, delete: if isAdmin();
    }

    match /teacherDailyAttendance/{dailyId} {
       allow read: if isAdmin() || isOwner(dailyId.split('_')[0]);
       allow create, update: if isOwner(dailyId.split('_')[0]) || isAdmin();
       allow delete: if isAdmin();
    }
    
    match /pelanggaran_siswa/{violationId} {
        allow read: if isGuru();
        allow create: if isGuru();
        allow update, delete: if isAdmin();
    }
    
    match /laporan_kegiatan/{reportId} {
        // Admins, designated report viewers, or the owner can read.
        allow read: if isAdmin() || isReportViewer() || isOwner(resource.data.createdByUid);
        allow create: if isGuru();
        // Only the owner or an admin can modify.
        allow update, delete: if isAdmin() || isOwner(resource.data.createdByUid);
    }
    
    match /agenda_kelas/{agendaId} {
        // Admins and owners can read all agendas. Simplifies queries.
        allow read: if isAdmin() || isOwner(resource.data.teacherUid);
        allow create: if isGuru();
        // Only owner or admin can modify
        allow update, delete: if isAdmin() || isOwner(resource.data.teacherUid);
    }

    // --- System & Config ---
    
    match /schoolConfig/main_profile {
        allow read: if isSignedIn();
        allow write: if isAdmin();
    }

    match /activity_logs/{logId} {
      allow read, write: if isAdmin();
    }
  }
}
